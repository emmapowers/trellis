[workspace]
name = "trellis"
version = "0.1.0"
authors = ["Emma Powers <emma@emmaponders.com>"]
channels = ["conda-forge"]
platforms = ["osx-arm64", "linux-64"]

[dependencies]
python = "3.13.*"
pip = ">=24,<26"
black = ">=25.1.0,<26"
ruff = ">=0.8,<1"
pytest = ">=8,<9"
pytest-cov = ">=6,<7"
nodejs = ">=22"
playwright = ">=1.57.0,<2"

[pypi-dependencies]
trellis = { path = ".", editable = true }
mypy = ">=1.15,<2"
pydoc-markdown = ">=4.8,<5"

# Feature for desktop extras (pytauri-wheel)
[feature.desktop.pypi-dependencies]
trellis = { path = ".", editable = true, extras = ["desktop"] }

# Environments
[environments]
default = ["desktop"]
ci = []

[tasks]
# Formatting
fmt = { cmd = "black src tests", description = "Format code with black" }
fmt-check = { cmd = "black --check src tests", description = "Check black formatting" }
ruff-fix = { cmd = "ruff check --fix src tests", depends-on = ["fmt"], description = "Run ruff with auto-fix" }
ruff-check = { cmd = "ruff check src tests", description = "Check ruff linting" }

# Type checking
mypy = { cmd = "dmypy run src examples", description = "Run mypy (daemon)" }
mypy-ci = { cmd = "mypy src examples", description = "Run mypy (full check)" }

# Testing
test = { cmd = "pytest tests/py", description = "Run Python tests" }
test-cov = { cmd = "pytest tests/py --cov=src/trellis --cov-report=term-missing", description = "Run Python tests with coverage" }
install-js-test-deps = { cmd = "npm install", cwd = "tests/js", description = "Install JavaScript test dependencies" }
test-js = { cmd = "npm test", cwd = "tests/js", depends-on = ["install-js-test-deps"], description = "Run JavaScript unit tests" }

# Composite lint/test tasks
cleanup = { depends-on = ["fmt", "ruff-fix"], description = "Run formatters with auto-fix" }
lint = { depends-on = ["fmt-check", "ruff-check", "mypy-ci"], description = "Check all linters (no fix)" }
ci = { depends-on = ["lint", "test", "test-js"], description = "Run CI checks" }

# Build tasks (use Make for incremental builds)
build-wheel = { cmd = "make wheel", description = "Build wheel (incremental)" }
build-bundles = { cmd = "make bundles", description = "Build all platform bundles (incremental)" }
build = { cmd = "make wheel bundles", description = "Build wheel and all bundles (incremental)" }
clean = { cmd = "make clean", description = "Clean build artifacts" }

# Examples (all depend on build artifacts)
demo = { cmd = "python examples/demo.py", depends-on = ["build"], description = "Run counter demo" }
showcase = { cmd = "python -m examples.widget_showcase", depends-on = ["build"], description = "Run widget showcase" }
sliders = { cmd = "python examples/all_sliders_all_the_time.py", depends-on = ["build"], description = "Run slider performance demo" }
breakfast = { cmd = "python -m examples.breakfast_todo", depends-on = ["build"], description = "Run breakfast todo app" }

# Playground
install-playground-deps = { cmd = "npm install", cwd = "docs/static/playground", description = "Install playground dependencies" }
build-playground = { cmd = "make playground", description = "Build playground (incremental)" }
playground = { cmd = "python -c \"import http.server, socketserver, socket; s=socket.socket(); s.bind(('',0)); port=s.getsockname()[1]; s.close(); print(f'\\n  Playground: http://localhost:{port}/playground/\\n'); http.server.test(HandlerClass=http.server.SimpleHTTPRequestHandler, port=port, bind='127.0.0.1')\"", cwd = "docs/static", depends-on = ["build-playground", "copy-wheel-to-docs"], description = "Run playground server" }

# Documentation
generate-api-docs = { cmd = "make api-docs", description = "Generate API docs (incremental)" }
generate-example-pages = { cmd = "make example-pages", description = "Generate example pages (incremental)" }
copy-wheel-to-docs = { cmd = "make docs-wheel", description = "Copy wheel to docs (incremental)" }
build-docs = { cmd = "make docs", description = "Build documentation site (incremental)" }
serve-docs = { cmd = "npm run start", cwd = "docs", depends-on = ["generate-api-docs", "build-playground", "generate-example-pages", "copy-wheel-to-docs"], description = "Serve docs locally with hot reload" }
watch-api-docs = { cmd = "watchfiles 'pixi run generate-api-docs' src/trellis", description = "Watch Python source and regenerate API docs" }

[target.unix.activation]
scripts = ["scripts/install-npm-deps.sh"]
