[workspace]
name = "trellis"
version = "0.1.0"
authors = ["Emma Powers <emma@emmaponders.com>"]
channels = ["conda-forge"]
platforms = ["osx-arm64", "linux-64"]

[dependencies]
python = "3.14.*"
pip = ">=24,<26"
black = ">=25.1.0,<26"
ruff = ">=0.8,<1"
pytest = ">=8,<9"
pytest-cov = ">=6,<7"
nodejs = ">=22"

[pypi-dependencies]
trellis = { path = ".", editable = true }
mypy = ">=1.15,<2"

[tasks]
fmt = { cmd = "black src", description = "Format code with black" }
fmt-check = { cmd = "black --check src", description = "Check black formatting" }

ruff-fix = { cmd = "ruff check --fix src", depends-on = ["fmt"], description = "Run ruff with auto-fix" }
ruff-check = { cmd = "ruff check src", description = "Check ruff linting" }

mypy = { cmd = "dmypy run src", description = "Run mypy (daemon)" }
mypy-ci = { cmd = "mypy src", description = "Run mypy (full check)" }

test = { cmd = "pytest", description = "Run unit tests" }
test-cov = { cmd = "pytest --cov=src/trellis --cov-report=term-missing", description = "Run unit tests with coverage" }
test-integration = { cmd = "pytest tests/integration -vv", description = "Run integration tests (requires network)" }

cleanup = { depends-on = ["fmt", "ruff-fix"], description = "Run formatters with auto-fix" }
lint = { depends-on = ["fmt-check", "ruff-check", "mypy-ci"], description = "Check all linters (no fix)" }
ci = { depends-on = ["lint", "test", "test-integration"], description = "Run CI checks" }

build-wheel = { cmd = "pip wheel . -w dist --no-deps", description = "Build wheel" }
clean = { cmd = "rm -rf dist build .mypy_cache .ruff_cache .pytest_cache .coverage", description = "Clean build artifacts" }

# Client build tasks
build-client = { cmd = "npm install && npm run build", cwd = "src/trellis/client", description = "Build client bundle" }
watch-client = { cmd = "npm install && npm run watch", cwd = "src/trellis/client", description = "Watch and rebuild client" }

# Run demo
demo = { cmd = "python examples/demo.py", description = "Run the demo app" }

# Playground build tasks
build-playground = { cmd = "npm install && npm run build", cwd = "playground", depends-on = ["build-wheel"], description = "Build playground bundle" }
watch-playground = { cmd = "npm install && npm run watch", cwd = "playground", description = "Watch and rebuild playground" }

# Run playground test server (serve from project root so wheel is accessible)
playground = { cmd = "python -m http.server 8000", depends-on = ["build-playground"], description = "Run playground server (open http://localhost:8000/playground/)" }